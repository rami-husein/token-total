<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Token Total - LLM Token Counter</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial Black', 'Arial Bold', Gadget, sans-serif;
      background: #eaddac;
      color: #26274e;
      padding: 20px;
      font-weight: 900;
    }

    .header {
      max-width: 1200px;
      margin: 0 auto 30px;
      background: #318b73;
      padding: 40px;
      border: 6px solid #26274e;
      box-shadow: 12px 12px 0 #26274e;
      position: relative;
    }

    h1 {
      color: #eaddac;
      font-size: 3.5em;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: -2px;
      text-shadow: 4px 4px 0 #26274e;
      font-weight: 900;
    }

    .subtitle {
      color: #eaddac;
      font-size: 1.2em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .tabs {
      max-width: 1200px;
      margin: 0 auto 30px;
      background: #d2793e;
      border: 6px solid #26274e;
      box-shadow: 12px 12px 0 #26274e;
      overflow: visible;
    }

    .tab-nav {
      display: flex;
      border-bottom: 6px solid #26274e;
      background: #943c23;
    }

    .tab-button {
      flex: 1;
      padding: 20px;
      background: #943c23;
      border: none;
      border-right: 6px solid #26274e;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 900;
      color: #eaddac;
      transition: all 0.1s;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-family: 'Arial Black', sans-serif;
    }

    .tab-button:last-child {
      border-right: none;
    }

    .tab-button:hover {
      background: #d2793e;
      color: #26274e;
      transform: translate(-2px, -2px);
    }

    .tab-button.active {
      color: #26274e;
      background: #eaddac;
      border-bottom: none;
    }

    .tab-content {
      display: none;
      padding: 40px;
    }

    .tab-content.active {
      display: block;
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: #26274e;
      font-weight: 900;
      text-transform: uppercase;
    }

    .spinner {
      border: 8px solid #eaddac;
      border-top: 8px solid #943c23;
      border-radius: 0;
      width: 60px;
      height: 60px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Simple Demo Styles */
    .controls {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .control-group {
      flex: 1;
      min-width: 200px;
    }

    label {
      display: block;
      font-weight: 900;
      margin-bottom: 12px;
      color: #26274e;
      font-size: 1em;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    select {
      width: 100%;
      padding: 15px;
      border: 5px solid #26274e;
      border-radius: 0;
      font-size: 16px;
      background: #eaddac;
      cursor: pointer;
      font-weight: 900;
      font-family: 'Arial Black', sans-serif;
      box-shadow: 6px 6px 0 #26274e;
    }

    select:focus {
      outline: none;
      background: #318b73;
      color: #eaddac;
    }

    textarea {
      width: 100%;
      padding: 20px;
      border: 5px solid #26274e;
      border-radius: 0;
      font-size: 16px;
      font-family: 'Courier New', monospace;
      resize: vertical;
      min-height: 300px;
      background: #eaddac;
      font-weight: 700;
      box-shadow: 8px 8px 0 #26274e;
    }

    textarea:focus {
      outline: none;
      border-color: #943c23;
      border-width: 5px;
    }

    .stats {
      margin-top: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 25px;
    }

    .stat {
      background: #318b73;
      color: #eaddac;
      padding: 30px;
      border: 6px solid #26274e;
      text-align: center;
      box-shadow: 10px 10px 0 #26274e;
      position: relative;
    }

    .stat-value {
      font-size: 4em;
      font-weight: 900;
      display: block;
      text-shadow: 3px 3px 0 #26274e;
    }

    .stat-label {
      font-size: 1em;
      margin-top: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: 900;
    }

    /* Advanced Demo Styles */
    .advanced-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    @media (max-width: 968px) {
      .advanced-layout {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: #eaddac;
      border: 5px solid #26274e;
      border-radius: 0;
      padding: 25px;
      box-shadow: 8px 8px 0 #26274e;
    }

    .panel h2 {
      margin-bottom: 20px;
      color: #26274e;
      font-size: 1.5em;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 900;
    }

    .token-display {
      background: #eaddac;
      border: 5px solid #26274e;
      border-radius: 0;
      padding: 20px;
      min-height: 300px;
      font-family: 'Courier New', monospace;
      line-height: 2;
      overflow-wrap: break-word;
      word-break: break-all;
      font-weight: 700;
    }

    .token {
      display: inline;
      padding: 4px 8px;
      margin: 3px;
      border-radius: 0;
      border: 3px solid #26274e;
      cursor: pointer;
      transition: transform 0.1s;
      font-weight: 900;
    }

    .token:hover {
      transform: translate(-3px, -3px);
      box-shadow: 6px 6px 0 #26274e;
      z-index: 10;
    }

    .token-info {
      background: #318b73;
      color: #eaddac;
      border: 5px solid #26274e;
      border-radius: 0;
      padding: 20px;
      margin-top: 20px;
      display: none;
      box-shadow: 8px 8px 0 #26274e;
    }

    .token-info.active {
      display: block;
    }

    .token-info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 3px solid #26274e;
      font-weight: 700;
    }

    .token-info-row:last-child {
      border-bottom: none;
    }

    button {
      background: #943c23;
      color: #eaddac;
      border: 5px solid #26274e;
      padding: 15px 30px;
      border-radius: 0;
      cursor: pointer;
      font-size: 16px;
      font-weight: 900;
      transition: all 0.1s;
      margin-top: 20px;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-family: 'Arial Black', sans-serif;
      box-shadow: 8px 8px 0 #26274e;
    }

    button:hover {
      background: #d2793e;
      color: #26274e;
      transform: translate(-2px, -2px);
      box-shadow: 10px 10px 0 #26274e;
    }

    button:active {
      transform: translate(2px, 2px);
      box-shadow: 4px 4px 0 #26274e;
    }

    /* Test Styles */
    .test {
      margin: 20px 0;
      padding: 20px;
      border-left: 10px solid #26274e;
      background: #eaddac;
      border-radius: 0;
      border: 5px solid #26274e;
      box-shadow: 6px 6px 0 #26274e;
    }

    .test.pass {
      border-left: 10px solid #318b73;
      background: #318b73;
      color: #eaddac;
    }

    .test.fail {
      border-left: 10px solid #943c23;
      background: #d2793e;
      color: #26274e;
    }

    .test-name {
      font-weight: 900;
      margin-bottom: 12px;
      text-transform: uppercase;
      font-size: 1.1em;
    }

    .test.pass .test-name {
      color: #eaddac;
    }

    .test.fail .test-name {
      color: #26274e;
    }

    .expected {
      font-family: monospace;
      font-weight: 900;
    }

    .actual {
      font-family: monospace;
      font-weight: 900;
    }

    .test.pass .expected,
    .test.pass .actual {
      color: #eaddac;
    }

    .test.fail .expected,
    .test.fail .actual {
      color: #26274e;
    }

    .summary {
      background: #318b73;
      border: 6px solid #26274e;
      border-radius: 0;
      padding: 30px;
      margin-top: 30px;
      box-shadow: 10px 10px 0 #26274e;
      color: #eaddac;
    }

    .summary h2 {
      color: #eaddac;
      margin-bottom: 15px;
      text-transform: uppercase;
      font-weight: 900;
      text-shadow: 3px 3px 0 #26274e;
    }

    .summary pre {
      background: #26274e;
      color: #eaddac;
      padding: 20px;
      border-radius: 0;
      font-size: 1.1em;
      border: 4px solid #eaddac;
      font-weight: 700;
    }

    /* Library Usage Styles */
    .code-example {
      background: #26274e;
      color: #eaddac;
      padding: 25px;
      border-radius: 0;
      font-family: 'Courier New', monospace;
      font-size: 1em;
      margin: 25px 0;
      overflow-x: auto;
      border: 5px solid #26274e;
      box-shadow: 8px 8px 0 #943c23;
      font-weight: 700;
    }

    .code-example .keyword { color: #318b73; font-weight: 900; }
    .code-example .string { color: #d2793e; font-weight: 700; }
    .code-example .comment { color: #eaddac; opacity: 0.7; }
    .code-example .function { color: #943c23; font-weight: 900; }

    .usage-section {
      margin-bottom: 40px;
    }

    .usage-section h3 {
      color: #26274e;
      margin-bottom: 20px;
      font-size: 1.8em;
      text-transform: uppercase;
      font-weight: 900;
      letter-spacing: -1px;
    }

    .usage-section p {
      line-height: 1.8;
      margin-bottom: 20px;
      color: #26274e;
      font-weight: 700;
      font-size: 1.1em;
    }

    .error {
      background: #943c23;
      color: #eaddac;
      padding: 20px;
      border-radius: 0;
      margin-top: 20px;
      border: 5px solid #26274e;
      box-shadow: 8px 8px 0 #26274e;
      font-weight: 900;
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Token Total</h1>
    <p class="subtitle">Count LLM tokens in your browser - BASED ON OPENAI'S <a href="https://github.com/openai/tiktoken" target="_blank" rel="noopener noreferrer">TIKTOKEN</a></p>
  </div>

  <div id="loading" class="tabs">
    <div class="loading">
      <div class="spinner"></div>
      <div>Loading tokenizer...</div>
    </div>
  </div>

  <div id="app" class="tabs" style="display: none;">
    <div class="tab-nav">
      <button class="tab-button active" data-tab="simple">Simple Counter</button>
      <button class="tab-button" data-tab="advanced">Token Visualizer</button>
      <button class="tab-button" data-tab="tests">Run Tests</button>
      <button class="tab-button" data-tab="usage">Library Usage</button>
      <button class="tab-button" data-tab="howto" onclick="window.location.href='how-it-works.html'">How It Works</button>
    </div>

    <!-- Simple Demo Tab -->
    <div id="simple" class="tab-content active">
      <div class="controls">
        <div class="control-group">
          <label for="simple-model">Model:</label>
          <select id="simple-model">
            <optgroup label="GPT-4o">
              <option value="gpt-4o" selected>gpt-4o</option>
              <option value="gpt-4o-mini">gpt-4o-mini</option>
            </optgroup>
            <optgroup label="GPT-4">
              <option value="gpt-4">gpt-4</option>
              <option value="gpt-4-turbo">gpt-4-turbo</option>
            </optgroup>
            <optgroup label="GPT-3.5">
              <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
            </optgroup>
          </select>
        </div>

        <div class="control-group">
          <label for="simple-encoding">Encoding:</label>
          <select id="simple-encoding">
            <option value="o200k_base">o200k_base (GPT-4o)</option>
            <option value="cl100k_base">cl100k_base (GPT-4)</option>
            <option value="p50k_base">p50k_base (GPT-3)</option>
            <option value="r50k_base">r50k_base (older)</option>
          </select>
        </div>
      </div>

      <label for="simple-input">Enter text to tokenize:</label>
      <textarea 
        id="simple-input" 
        placeholder="Type or paste your text here...">Hello, world! This is a demo of the token counter.</textarea>

      <div class="stats">
        <div class="stat">
          <span class="stat-value" id="simple-tokenCount">0</span>
          <span class="stat-label">Tokens</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="simple-charCount">0</span>
          <span class="stat-label">Characters</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="simple-ratio">0.0</span>
          <span class="stat-label">Chars/Token</span>
        </div>
      </div>

      <div id="simple-error" class="error" style="display: none;"></div>
    </div>

    <!-- Advanced Demo Tab -->
    <div id="advanced" class="tab-content">
      <div class="controls">
        <div class="control-group">
          <label for="advanced-model">Model:</label>
          <select id="advanced-model">
            <option value="gpt-4o" selected>gpt-4o</option>
            <option value="gpt-4">gpt-4</option>
            <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
          </select>
        </div>
        <div class="control-group">
          <label for="advanced-encoding">Encoding:</label>
          <select id="advanced-encoding">
            <option value="o200k_base">o200k_base</option>
            <option value="cl100k_base">cl100k_base</option>
            <option value="p50k_base">p50k_base</option>
          </select>
        </div>
      </div>

      <div class="stats">
        <div class="stat">
          <span class="stat-value" id="advanced-tokenCount">0</span>
          <span class="stat-label">Tokens</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="advanced-charCount">0</span>
          <span class="stat-label">Characters</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="advanced-ratio">0.0</span>
          <span class="stat-label">Chars/Token</span>
        </div>
      </div>

      <button onclick="copyTokens()">Copy Token IDs</button>

      <div class="advanced-layout">
        <div class="panel">
          <h2>Input Text</h2>
          <textarea id="advanced-input" placeholder="Type or paste your text here...">The quick brown fox jumps over the lazy dog. ðŸ¦Š</textarea>
        </div>

        <div class="panel">
          <h2>Tokenized Output</h2>
          <div id="token-display" class="token-display">Tokens will appear here...</div>
          <div id="token-info" class="token-info"></div>
        </div>
      </div>
    </div>

    <!-- Tests Tab -->
    <div id="tests" class="tab-content">
      <div id="test-results"></div>
      <div id="test-summary" class="summary" style="display: none;"></div>
    </div>

    <!-- Library Usage Tab -->
    <div id="usage" class="tab-content">
      <div class="usage-section">
        <h3>Installation</h3>
        <p>No installation needed! Just include the module in your HTML:</p>
        <div class="code-example"><span class="keyword">&lt;script</span> <span class="function">type</span>=<span class="string">"module"</span><span class="keyword">&gt;</span>
  <span class="keyword">import</span> { encodingForModel } <span class="keyword">from</span> <span class="string">'./src/index.js'</span>;
<span class="keyword">&lt;/script&gt;</span></div>
      </div>

      <div class="usage-section">
        <h3>Basic Usage</h3>
        <p>Count tokens for a specific model:</p>
        <div class="code-example"><span class="keyword">import</span> { <span class="function">encodingForModel</span> } <span class="keyword">from</span> <span class="string">'./src/index.js'</span>;

<span class="keyword">const</span> enc = <span class="keyword">await</span> <span class="function">encodingForModel</span>(<span class="string">'gpt-4'</span>);
<span class="keyword">const</span> tokens = enc.<span class="function">encode</span>(<span class="string">'Hello, world!'</span>);

console.<span class="function">log</span>(tokens); <span class="comment">// [9906, 11, 1917, 0]</span>
console.<span class="function">log</span>(tokens.length); <span class="comment">// 4</span></div>
      </div>

      <div class="usage-section">
        <h3>Encode & Decode</h3>
        <p>Convert between text and tokens:</p>
        <div class="code-example"><span class="keyword">const</span> enc = <span class="keyword">await</span> <span class="function">encodingForModel</span>(<span class="string">'gpt-4'</span>);

<span class="comment">// Encode text to tokens</span>
<span class="keyword">const</span> tokens = enc.<span class="function">encode</span>(<span class="string">'Hello, world!'</span>);

<span class="comment">// Decode tokens back to text</span>
<span class="keyword">const</span> text = enc.<span class="function">decode</span>(tokens);
console.<span class="function">log</span>(text); <span class="comment">// "Hello, world!"</span>

<span class="comment">// Decode to bytes</span>
<span class="keyword">const</span> bytes = enc.<span class="function">decodeBytes</span>(tokens);
console.<span class="function">log</span>(bytes); <span class="comment">// Uint8Array [72, 101, 108, 108, 111, ...]</span></div>
      </div>

      <div class="usage-section">
        <h3>Get Encoding by Name</h3>
        <p>Use a specific encoding directly:</p>
        <div class="code-example"><span class="keyword">import</span> { <span class="function">getEncoding</span> } <span class="keyword">from</span> <span class="string">'./src/index.js'</span>;

<span class="keyword">const</span> enc = <span class="keyword">await</span> <span class="function">getEncoding</span>(<span class="string">'cl100k_base'</span>);
<span class="keyword">const</span> tokens = enc.<span class="function">encode</span>(<span class="string">'Hello!'</span>);</div>
      </div>

      <div class="usage-section">
        <h3>Count Tokens</h3>
        <p>Quick token counting utility:</p>
        <div class="code-example"><span class="keyword">import</span> { <span class="function">countTokens</span> } <span class="keyword">from</span> <span class="string">'./src/index.js'</span>;

<span class="keyword">const</span> count = <span class="keyword">await</span> <span class="function">countTokens</span>(<span class="string">'Hello, world!'</span>, <span class="string">'gpt-4'</span>);
console.<span class="function">log</span>(count); <span class="comment">// 4</span></div>
      </div>

      <div class="usage-section">
        <h3>Special Tokens</h3>
        <p>Handle special tokens in your text:</p>
        <div class="code-example"><span class="keyword">const</span> enc = <span class="keyword">await</span> <span class="function">encodingForModel</span>(<span class="string">'gpt-4'</span>);

<span class="comment">// Allow specific special tokens</span>
<span class="keyword">const</span> tokens = enc.<span class="function">encode</span>(<span class="string">'Hello &lt;|endoftext|&gt;'</span>, {
  allowedSpecial: <span class="keyword">new</span> <span class="function">Set</span>([<span class="string">'&lt;|endoftext|&gt;'</span>])
});

<span class="comment">// Allow all special tokens</span>
<span class="keyword">const</span> tokens2 = enc.<span class="function">encode</span>(<span class="string">'text &lt;|endoftext|&gt;'</span>, {
  allowedSpecial: <span class="string">'all'</span>
});</div>
      </div>

      <div class="usage-section">
        <h3>List Available Models & Encodings</h3>
        <p>Discover supported models and encodings:</p>
        <div class="code-example"><span class="keyword">import</span> { <span class="function">listModelNames</span>, <span class="function">listEncodingNames</span> } <span class="keyword">from</span> <span class="string">'./src/index.js'</span>;

console.<span class="function">log</span>(<span class="function">listModelNames</span>());
<span class="comment">// ['gpt-4', 'gpt-4o', 'gpt-3.5-turbo', ...]</span>

console.<span class="function">log</span>(<span class="function">listEncodingNames</span>());
<span class="comment">// ['cl100k_base', 'o200k_base', 'p50k_base', ...]</span></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { encodingForModel, getEncoding } from './src/index.js';

    let simpleEncoding = null;
    let advancedEncoding = null;
    let advancedTokens = [];
    let updateTimeout = null;

    const colors = [
      '#943c23', '#d2793e', '#eaddac', '#318b73', '#26274e',
      '#943c23', '#d2793e', '#eaddac', '#318b73', '#26274e'
    ];

    // Initialize
    async function init() {
      try {
        simpleEncoding = await encodingForModel('gpt-4o');
        advancedEncoding = simpleEncoding;
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').style.display = 'block';

        setupTabs();
        setupSimpleDemo();
        setupAdvancedDemo();
        
        // Initial updates
        updateSimpleCount();
        updateAdvancedDisplay();
      } catch (err) {
        document.getElementById('loading').innerHTML = 
          `<div class="error">Failed to load tokenizer: ${err.message}</div>`;
      }
    }

    // Tab switching
    function setupTabs() {
      const buttons = document.querySelectorAll('.tab-button');
      const contents = document.querySelectorAll('.tab-content');

      buttons.forEach(button => {
        button.addEventListener('click', () => {
          const tabName = button.dataset.tab;
          
          buttons.forEach(b => b.classList.remove('active'));
          contents.forEach(c => c.classList.remove('active'));
          
          button.classList.add('active');
          document.getElementById(tabName).classList.add('active');

          // Run tests when switching to tests tab
          if (tabName === 'tests' && document.getElementById('test-results').children.length === 0) {
            runTests();
          }
        });
      });
    }

    // Simple Demo
    function setupSimpleDemo() {
      document.getElementById('simple-input').addEventListener('input', () => {
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(updateSimpleCount, 300);
      });

      document.getElementById('simple-model').addEventListener('change', async (e) => {
        try {
          simpleEncoding = await encodingForModel(e.target.value);
          updateSimpleCount();
        } catch (err) {
          showSimpleError(err.message);
        }
      });

      document.getElementById('simple-encoding').addEventListener('change', async (e) => {
        try {
          simpleEncoding = await getEncoding(e.target.value);
          updateSimpleCount();
        } catch (err) {
          showSimpleError(err.message);
        }
      });
    }

    function updateSimpleCount() {
      const text = document.getElementById('simple-input').value;
      const charCount = text.length;

      try {
        const tokens = simpleEncoding.encode(text);
        const tokenCount = tokens.length;
        const ratio = tokenCount > 0 ? (charCount / tokenCount).toFixed(1) : 0;

        document.getElementById('simple-tokenCount').textContent = tokenCount;
        document.getElementById('simple-charCount').textContent = charCount;
        document.getElementById('simple-ratio').textContent = ratio;

        document.getElementById('simple-error').style.display = 'none';
      } catch (err) {
        showSimpleError(err.message);
      }
    }

    function showSimpleError(message) {
      const errorEl = document.getElementById('simple-error');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    // Advanced Demo
    function setupAdvancedDemo() {
      document.getElementById('advanced-input').addEventListener('input', () => {
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(updateAdvancedDisplay, 300);
      });

      document.getElementById('advanced-model').addEventListener('change', async (e) => {
        advancedEncoding = await encodingForModel(e.target.value);
        updateAdvancedDisplay();
      });

      document.getElementById('advanced-encoding').addEventListener('change', async (e) => {
        advancedEncoding = await getEncoding(e.target.value);
        updateAdvancedDisplay();
      });
    }

    function updateAdvancedDisplay() {
      const text = document.getElementById('advanced-input').value;
      const charCount = text.length;

      try {
        advancedTokens = advancedEncoding.encode(text);
        const tokenCount = advancedTokens.length;
        const ratio = tokenCount > 0 ? (charCount / tokenCount).toFixed(1) : 0;

        document.getElementById('advanced-tokenCount').textContent = tokenCount;
        document.getElementById('advanced-charCount').textContent = charCount;
        document.getElementById('advanced-ratio').textContent = ratio;

        visualizeTokens();
      } catch (err) {
        document.getElementById('token-display').textContent = `Error: ${err.message}`;
      }
    }

    function visualizeTokens() {
      const tokenBytes = advancedEncoding.decodeTokensBytes(advancedTokens);
      const display = document.getElementById('token-display');
      display.innerHTML = '';

      tokenBytes.forEach((bytes, index) => {
        const tokenId = advancedTokens[index];
        const text = new TextDecoder().decode(bytes);
        const displayText = text.replace(/\n/g, 'â†µ\n').replace(/\t/g, 'â†’\t').replace(/ /g, 'Â·');
        
        const color = colors[tokenId % colors.length];
        const borderColor = darkenColor(color, 20);
        
        const span = document.createElement('span');
        span.className = 'token';
        span.textContent = displayText;
        span.style.backgroundColor = color;
        span.style.borderColor = borderColor;
        span.title = `Token #${index}: ID ${tokenId}`;
        span.onclick = () => showTokenInfo(index, tokenId, text, bytes);
        
        display.appendChild(span);
      });
    }

    function showTokenInfo(index, tokenId, text, bytes) {
      const info = document.getElementById('token-info');
      const bytesStr = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
      
      info.innerHTML = `
        <div class="token-info-row">
          <strong>Token Index:</strong>
          <span>${index}</span>
        </div>
        <div class="token-info-row">
          <strong>Token ID:</strong>
          <span>${tokenId}</span>
        </div>
        <div class="token-info-row">
          <strong>Text:</strong>
          <span>${JSON.stringify(text)}</span>
        </div>
        <div class="token-info-row">
          <strong>Bytes:</strong>
          <span>${bytesStr}</span>
        </div>
        <div class="token-info-row">
          <strong>Length:</strong>
          <span>${bytes.length} bytes</span>
        </div>
      `;
      info.classList.add('active');
    }

    function darkenColor(hex, percent) {
      const num = parseInt(hex.slice(1), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) - amt;
      const G = (num >> 8 & 0x00FF) - amt;
      const B = (num & 0x0000FF) - amt;
      return '#' + (
        0x1000000 + 
        (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255)
      ).toString(16).slice(1);
    }

    window.copyTokens = function() {
      const text = JSON.stringify(advancedTokens);
      navigator.clipboard.writeText(text).then(() => {
        alert('Token IDs copied to clipboard!');
      });
    };

    // Tests
    async function runTests() {
      const TESTS = [
        {
          name: 'GPT-2: hello world',
          encoding: 'r50k_base',
          text: 'hello world',
          expected: [31373, 995],
        },
        {
          name: 'cl100k_base: hello world',
          encoding: 'cl100k_base',
          text: 'hello world',
          expected: [15339, 1917],
        },
        {
          name: 'Empty string',
          encoding: 'cl100k_base',
          text: '',
          expected: [],
        },
        {
          name: 'Single character',
          encoding: 'cl100k_base',
          text: 'a',
          expected: [64],
        },
        {
          name: 'Numbers',
          encoding: 'cl100k_base',
          text: '12345',
          expected: [4513, 1774],
        },
          {
            name: 'Unicode',
            encoding: 'cl100k_base',
            text: 'ä½ å¥½',
            expected: [57668, 53901],
          },
          {
            name: 'Special characters',
            encoding: 'cl100k_base',
            text: '!@#$%',
            expected: [0, 31, 49177, 4],
          },
        {
          name: 'Newlines',
          encoding: 'cl100k_base',
          text: 'hello\nworld',
          expected: [15339, 198, 14957],
        },
        {
          name: 'Special token allowed',
          encoding: 'cl100k_base',
          text: 'hello <|endoftext|>',
          expected: [15339, 220, 100257],
          options: { allowedSpecial: new Set(['<|endoftext|>']) },
        },
      ];

      const results = document.getElementById('test-results');
      const summary = document.getElementById('test-summary');
      results.innerHTML = '';
      let passed = 0;
      let failed = 0;

      for (const test of TESTS) {
        const testEl = document.createElement('div');
        testEl.className = 'test';

        try {
          const encoding = await getEncoding(test.encoding);
          const actual = encoding.encode(test.text, test.options || {});
          
          const match = JSON.stringify(actual) === JSON.stringify(test.expected);
          
          if (match) {
            testEl.classList.add('pass');
            testEl.innerHTML = `
              <div class="test-name">âœ“ ${test.name}</div>
              <div>Result: <span class="actual">${JSON.stringify(actual)}</span></div>
            `;
            passed++;
          } else {
            testEl.classList.add('fail');
            testEl.innerHTML = `
              <div class="test-name">âœ— ${test.name}</div>
              <div>Expected: <span class="expected">${JSON.stringify(test.expected)}</span></div>
              <div>Actual: <span class="actual">${JSON.stringify(actual)}</span></div>
            `;
            failed++;
          }

          const decoded = encoding.decode(actual);
          if (decoded !== test.text && test.text !== '') {
            testEl.classList.remove('pass');
            testEl.classList.add('fail');
            testEl.innerHTML += `<div style="color: #724310;">Decode mismatch: "${decoded}" !== "${test.text}"</div>`;
            if (match) {
              passed--;
              failed++;
            }
          }

        } catch (err) {
          testEl.classList.add('fail');
          testEl.innerHTML = `
            <div class="test-name">âœ— ${test.name}</div>
            <div style="color: #724310;">Error: ${err.message}</div>
          `;
          failed++;
        }

        results.appendChild(testEl);
      }

      summary.style.display = 'block';
      summary.innerHTML = `
        <h2>Test Summary</h2>
        <pre>Total: ${passed + failed}
Passed: ${passed}
Failed: ${failed}
Success Rate: ${((passed / (passed + failed)) * 100).toFixed(1)}%</pre>
      `;
    }

    init();
  </script>
</body>
</html>
